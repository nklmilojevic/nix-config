name: Build and Cache

on:
  push:
    branches: [main, test-attic]
    paths:
      - "**.nix"
      - "flake.lock"
      - "modules/**"
      - "hosts/**"
      - "lib/**"
  pull_request:
    branches: [main]
    paths:
      - "**.nix"
      - "flake.lock"
      - "modules/**"
      - "hosts/**"
      - "lib/**"
  workflow_dispatch:

env:
  CACHIX_CACHE: nkl-nix-config

jobs:
  # build-x86_64-linux:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v6
  #
  #     - uses: cachix/install-nix-action@v31
  #       with:
  #         nix_path: nixpkgs=channel:nixos-unstable
  #         extra_nix_config: |
  #           extra-substituters = https://nkl-nix-config.cachix.org
  #           extra-trusted-public-keys = nkl-nix-config.cachix.org-1:BFC4/yovGI+0E8ZZE0K3H6Mu2uBaqSU/kTnSvFQs5uE=
  #
  #     - uses: cachix/cachix-action@v16
  #       with:
  #         name: ${{ env.CACHIX_CACHE }}
  #         authToken: ${{ secrets.CACHIX_TOKEN }}
  #
  #     - name: Build server profile (x86_64-linux)
  #       run: nix build .#homeConfigurations.server.activationPackage
  #
  #     - name: Push to Cachix
  #       run: cachix push $CACHIX_CACHE ./result
  #
  # build-aarch64-linux:
  #   runs-on: ubuntu-24.04-arm
  #   steps:
  #     - uses: actions/checkout@v6
  #
  #     - uses: cachix/install-nix-action@v31
  #       with:
  #         nix_path: nixpkgs=channel:nixos-unstable
  #         extra_nix_config: |
  #           extra-substituters = https://nkl-nix-config.cachix.org
  #           extra-trusted-public-keys = nkl-nix-config.cachix.org-1:BFC4/yovGI+0E8ZZE0K3H6Mu2uBaqSU/kTnSvFQs5uE=
  #
  #     - uses: cachix/cachix-action@v16
  #       with:
  #         name: ${{ env.CACHIX_CACHE }}
  #         authToken: ${{ secrets.CACHIX_TOKEN }}
  #
  #     - name: Build server profile (aarch64-linux)
  #       run: nix build .#homeConfigurations.server-aarch64.activationPackage
  #
  #     - name: Push to Cachix
  #       run: cachix push $CACHIX_CACHE ./result
  #
  build-aarch64-darwin:
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v6

      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            extra-substituters = https://nkl-nix-config.cachix.org
            extra-trusted-public-keys = nkl-nix-config.cachix.org-1:BFC4/yovGI+0E8ZZE0K3H6Mu2uBaqSU/kTnSvFQs5uE=

      - uses: cachix/cachix-action@v16
        with:
          name: ${{ env.CACHIX_CACHE }}
          authToken: ${{ secrets.CACHIX_TOKEN }}

      - name: Build darwin profile (aarch64-darwin)
        run: nix build .#darwinConfigurations.daedalus.system

      - name: Push to Cachix
        run: cachix push $CACHIX_CACHE ./result

  notify:
    name: Telegram Notification
    runs-on: ubuntu-latest
    needs: [build-aarch64-darwin]
    # needs: [build-x86_64-linux, build-aarch64-linux, build-aarch64-darwin]
    if: always()
    steps:
      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            nix-config build: ${{ needs.build-x86_64-linux.result == 'success' && needs.build-aarch64-linux.result == 'success' && needs.build-aarch64-darwin.result == 'success' && 'PASSED' || 'FAILED' }}

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

            x86_64-linux: ${{ needs.build-x86_64-linux.result }}
            aarch64-linux: ${{ needs.build-aarch64-linux.result }}
            aarch64-darwin: ${{ needs.build-aarch64-darwin.result }}

            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
